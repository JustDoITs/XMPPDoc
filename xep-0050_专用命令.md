# XEP-0050:专有命令

by Rusher 

>	[XEP-0050: Ad-Hoc Commands](http://xmpp.org/extensions/xep-0050.html)


## 1.Introduction
此扩展协议的可以使两个实体间建立一个命令会话,而不需要特定的命名空间，同时，还定义了会话的类型，类似于菜单的概念。

定义这样的一个协议的动机是扩展Jabber的技术，使之不仅仅应用在即时通信上。就像Web应用一样，Jabber应用也是需要一个客户端，一个用户可以通过他来和web应用交互。客户端不需要特殊的改写就可以使用Jabber应用。

分配给此扩展协议的命名空间是**"http://jabber.org/protocol/commands"**.这个命名空间依赖`<iq/>`元素来执行命令，使用`<message/>`返回执行结果。协议依赖[XEP-0030: Service Discovery](http://xmpp.org/extensions/xep-0030.html)查询服务支持的命令。协议倾向于实现[XEP-0004: Data Forms](http://xmpp.org/extensions/xep-0004.html)扩展协议，但这不是必需的。

## 2.Use Cases

### 2.1 Discovering Support
 
请求者使用*服务查询*来查看服务端是否支持x-commands。请求者生成一个"#info"查询发到服务端。如果支持，服务端返回一个`<feature/>`元素，其中`var`属性的值为`"http://jabber.org/protocol/commands"`.
 
客户端请求服务端：

	<iq type='get'
	    to='responder@domain'
	    from='requester@domain'>
	  <query xmlns='http://jabber.org/protocol/disco#info'/>
	</iq>
		
服务端返回客户端：

	<iq type='result'
	    from='responder@domain'
	    to='requester@domain'>
	  <query xmlns='http://jabber.org/protocol/disco#info'>
	    ...
	    <feature var='http://jabber.org/protocol/commands'/>
	    ...
	  </query>
	</iq>

### 2.2 获取命令列表

…一些信息查询 …

### 2.4 命令执行过程

### 2.4.1 单步执行

请求这发一个包含命令的`<iq/>`来执行命令.

执行命令

	<iq type='set' to='responder@domain' id='exec1'>
	  <command xmlns='http://jabber.org/protocol/commands'
	           node='list'
	           action='execute'/>
	</iq>
	
请求命令可能包含`action='execute'`，这是默认值。

如果命令不包含其他的交互步骤，服务端发送一个类似下面的数据：

	<iq type='result' from='responder@domain' to='requester@domain' id='exec1'>
	  <command xmlns='http://jabber.org/protocol/commands'
	           sessionid='list:20020923T213616Z-700'
	           node='list'
	           status='completed'>
	    <x xmlns='jabber:x:data' type='result'>
	      <title>Available Services</title>
	      <reported>
	        <field var='service' label='Service'/>
	        <field var='runlevel-1' label='Single-User mode'/>
	        <field var='runlevel-2' label='Non-Networked Multi-User mode'/>
	        <field var='runlevel-3' label='Full Multi-User mode'/>
	        <field var='runlevel-5' label='X-Window mode'/>
	      </reported>
	      <item>
	        <field var='service'><value>httpd</value></field>
	        <field var='runlevel-1'><value>off</value></field>
	        <field var='runlevel-2'><value>off</value></field>
	        <field var='runlevel-3'><value>on</value></field>
	        <field var='runlevel-5'><value>on</value></field>
	      </item>
	      <item>
	        <field var='service'><value>postgresql</value></field>
	        <field var='runlevel-1'><value>off</value></field>
	        <field var='runlevel-2'><value>off</value></field>
	        <field var='runlevel-3'><value>on</value></field>
	        <field var='runlevel-5'><value>on</value></field>
	      </item>
	      <item>
	        <field var='service'><value>jabberd</value></field>
	        <field var='runlevel-1'><value>off</value></field>
	        <field var='runlevel-2'><value>off</value></field>
	        <field var='runlevel-3'><value>on</value></field>
	        <field var='runlevel-5'><value>on</value></field>
	      </item>
	    </x>
	  </command>
	</iq>

上面的返回数据是"jabber:x:data"规格的表单。

### 2.4.2 多步执行

如果命令需要更多的交互步骤，服务端返回关于命令的信息的`<iq/>`结果。

执行命令请求(stage1)

	<iq type='set' to='responder@domain' id='exec1'>
	  <command xmlns='http://jabber.org/protocol/commands'
	           node='config'
	           action='execute'/>
	</iq>

返回执行结果(stage1)

	<iq type='result' from='responder@domain' to='requester@domain' id='exec1'>
	  <command xmlns='http://jabber.org/protocol/commands'
	           sessionid='config:20020923T213616Z-700'
	           node='config'
	           status='executing'>
	    <actions execute='next'>
	      <next/>
	    </actions>
	    <x xmlns='jabber:x:data' type='form'>
	      <title>Configure Service</title>
	      <instructions>
	        Please select the service to configure.
	      </instructions>
	      <field var='service' label='Service' type='list-single'>
	        <option><value>httpd</value></option>
	        <option><value>jabberd</value></option>
	        <option><value>postgresql</value></option>
	      </field>
	    </x>
	  </command>
	</iq>

`<command/>`应该包含`<actions/>`，用来规定下一步中允许执行哪一种类型的动作。`<actions/>`元素中的每个值和`<command/>`元素中的action属性相同.execute属性值表示下一步中的默认执行动作的类型。在上面的例子中，下一步的执行类型是'next'。

请求者继续提交表单，附带命令节点(command node)和sessionid

执行命令请求(stage2)

	<iq type='set' to='responder@domain' id='exec2'>
	  <command xmlns='http://jabber.org/protocol/commands'
	           sessionid='config:20020923T213616Z-700'
	           node='config'>
	    <x xmlns='jabber:x:data' type='submit'>
	      <field var='service'>
	        <value>httpd</value>
	      </field>
	    </x>
	  </command>
	</iq>

返回执行结果(stage2)

	<iq type='result' from='responder@domain' to='requester@domain' id='exec2'>
	  <command xmlns='http://jabber.org/protocol/commands'
	           sessionid='config:20020923T213616Z-700'
	           node='config'
	           status='executing'>
	    <actions execute='complete'>
	      <prev/>
	      <complete/>
	    </actions>
	    <x xmlns='jabber:x:data' type='form'>
	      <title>Configure Service</title>
	      <instructions>
	        Please select the run modes and state for 'httpd'.
	      </instructions>
	      <field var='runlevel' label='Run Modes' type='list-multi'>
	        <value>3</value>
	        <value>5</value>
	        <option label='Single-User'><value>1</value></option>
	        <option label='Non-Networked Multi-User'><value>2</value></option>
	        <option label='Full Multi-User'><value>3</value></option>
	        <option label='X-Window'><value>5</value></option>
	      </field>
	      <field var='state' label='Run State' type='list-single'>
	        <value>off</value>
	        <option label='Active'><value>off</value></option>
	        <option label='Inactive'><value>on</value></option>
	      </field>
	    </x>
	  </command>
	</iq>

执行命令请求(stage3)

	<iq type='set' to='responder@domain' id='exec3'>
	  <command xmlns='http://jabber.org/protocol/commands'
	           sessionid='config:20020923T213616Z-700'
	           node='config'>
	    <x xmlns='jabber:x:data' type='submit'>
	      <field var='mode'>
	        <value>3</value>
	      </field>
	      <field var='state'>
	        <value>on</value>
	      </field>
	    </x>
	  </command>
	</iq>

返回执行结果(stage3)

	<iq type='result' from='responder@domain' to='requester@domain' id='exec3'>
	  <command xmlns='http://jabber.org/protocol/commands'
	           sessionid='config:20020923T213616Z-700'
	           node='config'
	           status='completed'>
	    <note type='info'>Service 'httpd' has been configured.</note>
	  </command>
	</iq>

*我的解释: 由于stage2中返回的`<actions/>`有两种,'prev'和'complete'，上面的这一步演示了'complete'的执行，下面的例子演示'prev‘执行。*

如果请求者需要返回上一步，需要发送一个带"action='prev'"的命令iq.

执行命令请求(stage2 -> stage1)

	<iq type='set' to='responder@domain' id='exec2'>
	  <command xmlns='http://jabber.org/protocol/commands'
	           sessionid='config:20020923T213616Z-700'
	           node='config'
	           action='prev'/>
	</iq>

返回执行结果(stage2 -> stage1)

	<iq type='result' from='responder@domain' to='requester@domain' id='exec2'>
	  <command xmlns='http://jabber.org/protocol/commands'
	           sessionid='config:20020923T213616Z-700'
	           node='config'
	           status='executing'>
	    <actions execute='next'>
	      <next/>
	    </actions>
	    <x xmlns='jabber:x:data' type='form'>
	      <title>Configure Service</title>
	      <instructions>
	        Please select the service to configure.
	      </instructions>
	      <field var='service' label='Service' type='list-single'>
	        <value>httpd</value>
	        <option><value>httpd</value></option>
	        <option><value>jabberd</value></option>
	        <option><value>postgresql</value></option>
	      </field>
	    </x>
	  </command>
	</iq>
	
### 2.4.3 取消执行